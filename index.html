<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Meeting Timer</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f8f7f5">
<link rel="icon" href="./img/favicon.png">
<!-- Cloudflare Web Analytics -->
<script defer src="https://static.cloudflareinsights.com/beacon.min.js"
        data-cf-beacon='{"token": "9e80768d4f6c41f69cb40367aebcc56b"}'></script>
<!-- End Cloudflare Web Analytics -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f8f7f5; --ink:#2b3432; --muted:#8b827a;
  --card:#fff; --border:rgba(40,30,20,.10);
  --green:#6ecf9e; /* Play */
  --phase-intro:#87b9ff; /* Pause */
  --phase-review:#ffb766; /* Stop */
  --phase-outro:#87b9ff; /* blå avslutning (samme som intro) */
  --press:#cfc7bd; --pill:#fffefb; --radius:16px;
  --tl-green-1:#e9f3ec; --tl-green-2:#deefe4;
  --content-max:min(640px, 94vw);
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{margin:0;height:100%}
body{
  color:var(--ink);
  font-family:"Nunito",ui-rounded,-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  letter-spacing:.01em; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; min-height:100%;
  background-color:var(--bg);
  background-image: linear-gradient(rgba(255,255,255,.72), rgba(255,255,255,.72)), url('./img/paper-texture.png');
  background-size: auto, 300px 300px; background-repeat: repeat, repeat; background-attachment: fixed, fixed;
}
.container{flex:1 0 auto;max-width:980px;margin:0 auto;padding:16px 16px 28px;min-width:320px}
.footer{flex:0 0 auto;text-align:center;color:var(--muted);font-size:.9rem;padding:10px 0 14px}

.topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 0 18px;min-height:72px}
.brand{display:flex;align-items:center;gap:12px;position:relative}
.brand img{height:160px;width:auto;cursor:pointer;user-select:none;-webkit-user-drag:none;filter:drop-shadow(0 8px 24px rgba(70,50,30,.08));transition:transform .25s,filter .25s}
@media (min-width:768px){ .brand img{height:200px} }
@media (max-width:400px){ .brand img{height:120px} }

@keyframes spin2s{from{transform:rotate(0)}to{transform:rotate(360deg)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-2px)}40%{transform:translateX(2px)}60%{transform:translateX(-1px)}80%{transform:translateX(1px)}}
.logo-spin{animation:spin2s 2s linear}
.logo-shake{animation:shake .4s ease-in-out}

.card{background:var(--card);background-image:linear-gradient(rgba(255,255,255,.9),rgba(255,255,255,.9)), url('./img/paper-texture.png'); background-size:auto,300px 300px; background-repeat:repeat; border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 12px 40px rgba(70,50,30,.06);padding:14px}

.h1{font-size:clamp(1.1rem, 2.8vw, 1.38rem);font-weight:900;margin:18px auto 10px;max-width:var(--content-max);text-transform:uppercase}
.message{background:var(--pill);border:2px solid var(--border);border-radius:12px;padding:20px 22px;min-height:56px;box-shadow:0 8px 24px rgba(70,50,30,.05);margin:0 auto 20px;max-width:var(--content-max);color:#4a5552;font-size:clamp(1.1rem, 3.2vw, 1.62rem);line-height:1.3;display:flex;align-items:center}

/* Timeline */
.timeline-wrap{margin-top:22px; margin-bottom:40px; max-width:var(--content-max); margin-inline:auto; position:relative}
.timeline{position:relative;height:56px;border-radius:14px;overflow:visible;background:linear-gradient(180deg,var(--tl-green-1) 0%,#edf5f0 100%);border:1px solid var(--border)}
.slot{position:absolute;top:0;height:100%;opacity:.22}
#introSlot{background:var(--phase-intro)}
#reviewSlot{background:var(--phase-review)}
#outroSlot{background:var(--phase-outro)}
.para-slot{position:absolute;top:0;height:100%;display:flex;align-items:center;justify-content:center;border-left:1px solid rgba(50,35,25,.06);border-right:1px solid rgba(255,255,255,.55);font-weight:900;color:#2f3b34;text-shadow:0 1px 0 rgba(255,255,255,.55);cursor:pointer;box-sizing:border-box;min-width:14px;background:var(--tl-green-1)}
.para-slot.alt{background:var(--tl-green-2)}
.para-slot>div{pointer-events:none;white-space:nowrap;overflow:hidden;line-height:1}
.read-pin{position:absolute; left:50%; transform:translateX(-50%); bottom:-24px; width:18px; height:18px; background:url('./img/read-icon.png') center/contain no-repeat; pointer-events:none; opacity:0.95}
.elapsed{position:absolute;top:0;left:0;height:100%;background:rgba(58,111,82,.22);width:0%;transition:width .25s linear;z-index:2;pointer-events:none}
/* Rød tone for SP sin elapsed */
#elapsedSP{background:rgba(210,60,60,.28)}
.cursor{position:absolute;top:-10px;width:2px;height:76px;background:#2f3f49;left:0%;z-index:3}
/* Minuttstreker for SP */
#ticksSP{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none}
.tick{position:absolute;bottom:6px;width:2px;height:8px;background:rgba(30,40,35,.45);transform:translateX(-1px);}
.tick.major{height:12px;background:rgba(30,40,35,.65);}
.tick.xmajor{height:16px;background:rgba(30,40,35,.85);}

.big-clock,.clock{margin-top:16px;font-size:clamp(1.6rem, 9vw, 2.75rem);font-weight:900;color:#2f3b34;max-width:var(--content-max);margin-inline:auto;word-wrap:break-word}
#clockWT{margin-top:40px}
#clockSP{margin-top:40px}

.controls{display:flex;gap:12px;margin-top:12px;max-width:var(--content-max);margin-inline:auto;justify-content:flex-start;flex-wrap:wrap}
.round{width:58px;height:58px;border-radius:999px;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;box-shadow:0 10px 24px rgba(70,50,30,.08);transition:box-shadow .15s ease, filter .15s ease, transform .05s ease}
.round.pressed, .round.pressed:disabled{filter:brightness(.92) saturate(1.05); box-shadow:inset 0 4px 12px rgba(0,0,0,.22),0 6px 18px rgba(70,50,30,.12)}
.play{background:var(--green)}
.pause{background:var(--phase-intro); color:#ffffff}
.stop{background:var(--phase-review); color:#ffffff}
.round:active{transform:translateY(1px); box-shadow:inset 0 4px 10px rgba(0,0,0,.2),0 6px 18px rgba(70,50,30,.1)}

/* Presets */
.preset-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:14px;margin-top:22px}
.preset{border:1px solid var(--border);background:var(--pill);border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer;box-shadow:0 8px 20px rgba(70,50,30,.06);color:#2f3b34;font-size:1.05rem}
.preset.active{background:#2f3b34;color:#fff}

/* Target time adjuster */
.target-row{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px auto 8px; max-width:var(--content-max)}
.round.small{width:42px;height:42px;font-size:1.25rem; color:#2b3432; background:#ffffff; border:1px solid var(--border)}
.target-box{min-width:140px; text-align:center; font-weight:900; border-radius:999px; padding:8px 16px; border:1px solid var(--border);
  background:linear-gradient(180deg,var(--tl-green-1) 0%, #edf5f0 100%); color:#2f3b34; box-shadow:0 8px 20px rgba(70,50,30,.06)}

/* Milestone-bilde */
.milestone-img{max-width:56%;height:auto;margin:10px auto 0;display:block;opacity:1}

img{-webkit-user-drag:none;user-select:none;-webkit-touch-callout:none}
#wtControlsCard{max-width:var(--content-max);margin-inline:auto}
.select{appearance:none;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:var(--pill);font-weight:900;color:#2f3b4;box-shadow:0 4px 14px rgba(70,50,30,.05);min-width:180px;max-width:100%}
textarea{resize:vertical;}

/* Top row (select only) */
.wt-toprow{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:nowrap}
.select-article{flex:1 1 auto; max-width:100%; height:42px; line-height:42px; padding:0 12px; margin:0}
@media (max-width:560px){ .wt-toprow{flex-wrap:wrap} }

/* Stats row: avsnitt/les + 60/30 pill til høyre */
.stats-row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
.stats-row .modepill{margin-left:auto; display:inline-flex; align-items:center; height:34px}
.stats-row .modepill button{height:34px; line-height:34px; padding:0 12px; background:var(--pill); color:#2f3b34; border:1px solid var(--border); border-radius:999px}
/* Nøytral stil og ✓-markør for aktiv knapp */
.stats-row .modepill button.active::after{ content:"\2713"; font-weight:900; display:inline-block; margin-left:8px; }

/* Locked state when study started */
#wtControlsCard.locked{opacity:.55; filter:grayscale(25%);}
#wtControlsCard.locked .select, 
#wtControlsCard.locked .modepill button{pointer-events:none}

/* Spacing between notes and timer section */
#timerSection{margin-top:25px}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand" id="brandBox">
      <img id="logoImg" src="./img/meeting-timer-logo.png" alt="Meeting Timer logo">
    </div>
  </div>

  <!-- VAKTTÅRN -->
  <div id="wtControlsCard" class="card" style="max-width:var(--content-max);margin-inline:auto">
    <div class="wt-toprow">
      <select id="weekSel" class="select select-article" aria-label="Artikkel"><option>Laster …</option></select>
    </div>

    <div class="stats-row" style="margin-top:10px">
      <div class="pill" id="pillParas">Avsnitt: 0</div>
      <div class="pill" id="pillReads">📖 Les-skriftsteder: 0</div>
      <div class="modepill" aria-label="Studietid">
        <button id="mode60" type="button" class="active">60 min</button>
        <button id="mode30" type="button">30 min</button>
      </div>
    </div>
  </div>
  <div class="h1" id="articleTitle">—</div>
  <div class="message" id="message" aria-live="polite">Velg artikkel for å laste timer.</div>
  <div class="timeline-wrap">
    <div id="timeline" class="timeline">
      <div id="introSlot" class="slot"></div>
      <div id="reviewSlot" class="slot"></div>
      <div id="outroSlot" class="slot"></div>
      <div id="elapsed" class="elapsed"></div>
      <div id="cursor" class="cursor"></div>
    </div>
    <div class="clock" id="clockWT">00:00</div>
  </div>
  <div class="controls">
    <button id="playWT" class="round play">▶</button>
    <button id="pauseWT" class="round pause" disabled>❚❚</button>
    <button id="stopWT" class="round stop" disabled>■</button>
  </div>
  <div class="card" style="margin-top:14px;max-width:var(--content-max);margin-inline:auto">
    <textarea id="wtNotes" rows="3" style="width:100%;border:1px solid var(--border);border-radius:12px;padding:10px;font:inherit;color:#2b2a32;background:transparent;font-size:90%" placeholder="Her kan du notere."></textarea>
  </div>

  <!-- TIMER -->
  <section id="timerSection">
    <div class="card" style="max-width:var(--content-max);margin-inline:auto">
      <div class="h1">KLOKKE FOR MIDTUKEMØTET</div>
      <div id="spInputs">
        <div class="preset-row">
          <button class="preset" data-sec="0">0</button>
          <button class="preset" data-sec="300">5</button>
          <button class="preset" data-sec="600">10</button>
          <button class="preset" data-sec="900">15</button>
          <button class="preset" data-sec="1800">30</button>
        </div>
        <div class="target-row">
          <button id="decSP" class="round small" aria-label="Minus ett minutt">–</button>
          <div id="spTarget" class="target-box"><span id="spTargetDisplay">10:00</span></div>
          <button id="incSP" class="round small" aria-label="Pluss ett minutt">+</button>
        </div>
      </div>
      <div class="timeline-wrap">
        <div id="timelineSP" class="timeline">
          <div id="elapsedSP" class="elapsed"></div>
          <div id="cursorSP" class="cursor"></div>
          <div id="ticksSP"></div>
        </div>
      </div>
      <div class="big-clock" id="clockSP">00:00</div>
      <img id="msImg" class="milestone-img" alt="Milestone" src="./img/pick-milestone.png"/>
      <div class="controls">
        <button id="playSP" class="round play"><span id="playSPIcon">▶</span></button>
        <button id="pauseSP" class="round pause" disabled>❚❚</button>
        <button id="stopSP" class="round stop" disabled>■</button>
      </div>
    </div>
  </section>

  <div class="footer">Meeting Timer © 2025</div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
/* ===== Logo animasjon ===== */
(function(){ const logo=document.getElementById('logoImg'); if(!logo) return; logo.addEventListener('click',()=>{ logo.classList.remove('logo-spin','logo-shake'); void logo.offsetWidth; logo.classList.add('logo-spin'); setTimeout(()=>{ logo.classList.remove('logo-spin'); logo.classList.add('logo-shake'); setTimeout(()=>logo.classList.remove('logo-shake'),450); },2000); });})();

/* ===== Hjelpere ===== */
const $=s=>document.querySelector(s);
const fmt=s=>{s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60),r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0')}
function isoMondayLocal(d=new Date()){
  const day=d.getDay(); const diff=(day===0?-6:1-day);
  const monday=new Date(d.getFullYear(), d.getMonth(), d.getDate()+diff);
  const y=monday.getFullYear(), m=String(monday.getMonth()+1).padStart(2,'0'), dd=String(monday.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}

/* ===== WT konfig/modus ===== */
const WT_MODE_KEY='meetingTimer.wtMode'; // '60' | '30'
function getMode(){ return localStorage.getItem(WT_MODE_KEY) || '60'; }
function setMode(m){ localStorage.setItem(WT_MODE_KEY, m); }
function slots(){
  const total = (getMode()==='30') ? 1800 : 3600;
  const intro=90, review=90, outro=90; // 90s i begge moduser
  return { total, intro, review, outro, content: total - (intro+review+outro) };
}

/* ===== WT state ===== */
let paras=[], perParagraph=[], cumulative=[], totalParagraphs=0;
let reads=0, readSet=new Set();
let started=false, paused=false, startTs=null, accum=0, tickHandle=null;
let wtShownWarn=false; let wtMsgHoldTimer=null, wtMsgHoldUntil=0, wtLastE=0;

/* ===== Laste artikkeldata ===== */
async function fetchJSON(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw 0; return r.json();}
async function loadYear(y){ for(const p of [`data/no-${y}.json`,`Data/no-${y}.json`,`data/no-${y}`,`Data/no-${y}`]){ try{ return await fetchJSON(p+`?v=${Date.now().toString().slice(7)}`);}catch{} } throw 0; }
async function hydrateOptions(){
  const year=(new Date()).getFullYear();
  let items=[];
  try{
    const bundles=[];
    for(const yy of [year-1,year,year+1]){ try{ bundles.push(await loadYear(yy)); }catch{} }
    items=bundles.flatMap(p=>Array.isArray(p)?p:(p?.items||[])).filter(Boolean);
  }catch{ items=[]; }

  const curMon=isoMondayLocal(new Date());
  const parse=(s)=> new Date(s+"T00:00:00");
  const sorted=[...items].filter(it=>it.week_start).sort((a,b)=>parse(a.week_start)-parse(b.week_start));
  let current = sorted.find(it=>it.week_start===curMon);
  if(!current){
    const past = sorted.filter(it=>parse(it.week_start) <= parse(curMon));
    if(past.length){ current=past[past.length-1]; }
    else if(sorted.length){ current=sorted[0]; }
  }

  const sel=$('#weekSel'); sel.innerHTML='';
  let idx = sorted.indexOf(current);
  const start=Math.max(0, idx-6), end=Math.min(sorted.length, idx+6);
  const window=sorted.slice(start,end);
  window.forEach(it=>{ const o=document.createElement('option'); o.value=JSON.stringify(it); o.textContent=it.title||'(uten tittel)'; sel.appendChild(o); });
  sel.selectedIndex = window.indexOf(current);
  useItem(current);

  sel.addEventListener('change', (e)=>{ try{ useItem(JSON.parse(e.target.value)); }catch(err){} });
}
function useItem(it){
  $('#articleTitle').textContent=it.title||'—';
  totalParagraphs=(it.paragraphs|0)||(Array.isArray(it.words)?it.words.length:0)||(it.paras|0)||0;
  reads = it.reads|0;
  const rp = Array.isArray(it.readParas) ? it.readParas : (Array.isArray(it.read_paras) ? it.read_paras : null);
  readSet = new Set(rp || ((Number.isFinite(reads) && reads>0) ? Array.from({length:reads},(_,i)=>i+1) : []));
  paras=(it.words||[]).map((w,i)=>({num:i+1,words:w|0,q:1,les:0,hasAB:false}));
  if(paras.length!==totalParagraphs){ paras=Array.from({length:totalParagraphs},(_,i)=>({num:i+1,words:0,q:1,les:0,hasAB:false})); }
  $('#pillParas').textContent=`Avsnitt: ${totalParagraphs}`;
  $('#pillReads').textContent=`📖 Les-skriftsteder: ${readSet.size}`;
  computeAllocation(); drawTimeline(); resetWTUI();
}

/* ===== Fordele tid (WT) ===== */
const WPM=150, SEC_PER_Q=10, SEC_PER_READ=30, AB_BONUS=30;
function computeAllocation(){
  const S=slots();
  if(totalParagraphs<=0){perParagraph=[];cumulative=[];return;}
  const wps=WPM/60;
  const raw=Array.from({length:totalParagraphs},(_,i)=>{
    const p=paras[i]||{words:0,q:1,les:0,hasAB:false};
    let s=(p.words||0)/wps + (p.q||0)*SEC_PER_Q + (p.les||0)*SEC_PER_READ + (p.hasAB?AB_BONUS:0);
    s=Math.max(5,s);
    // +10% for de siste 5 avsnittene
    const lastN=Math.min(5,totalParagraphs);
    if(i>=totalParagraphs-lastN) s*=1.10;
    return s;
  });
  const scale=S.content/((raw.reduce((a,b)=>a+b,0))||1);
  perParagraph=raw.map(x=>x*scale);
  cumulative=[]; let acc=S.intro; for(let i=0;i<totalParagraphs;i++){cumulative.push(acc); acc+=perParagraph[i];}
}

/* ===== Tegn WT-tidslinje ===== */
function drawTimeline(){
  const S=slots();
  const t=$('#timeline'); if(!t) return;
  Array.from(t.querySelectorAll('.para-slot')).forEach(n=>n.remove());
  const pct=v=> (v/S.total*100).toFixed(4)+'%';
  $('#introSlot').style.left='0%'; $('#introSlot').style.width=pct(S.intro);
  $('#outroSlot').style.right='0%'; $('#outroSlot').style.width=pct(S.outro);
  $('#reviewSlot').style.right=pct(S.outro); $('#reviewSlot').style.width=pct(S.review);
  if(totalParagraphs<=0){$('#elapsed').style.width='0%'; $('#cursor').style.left='0%'; return;}
  const tlWidth=t.clientWidth||t.getBoundingClientRect().width||1; const pxPerSec=tlWidth/S.total;
  for(let i=1;i<=totalParagraphs;i++){
    const leftP=(cumulative[i-1]/S.total)*100, widthP=(perParagraph[i-1]/S.total)*100;
    const slot=document.createElement('div'); slot.className='para-slot'+(i%2===0?' alt':''); slot.style.left=leftP+'%'; slot.style.width=widthP+'%';
    const lbl=document.createElement('div'); const slotPx=perParagraph[i-1]*pxPerSec; const fs=Math.max(9,Math.min(14,Math.floor(slotPx*0.33)));
    lbl.style.fontSize=fs+'px'; lbl.textContent=String(i); slot.appendChild(lbl);
    if(readSet.has(i)){ const pin=document.createElement('i'); pin.className='read-pin'; slot.appendChild(pin); }
    // Klikk for å hoppe (når ikke spiller)
    slot.addEventListener('click',()=>{ if(started && !paused) return; const target=cumulative[i-1]; accum=Math.min(Math.round(target), S.total-S.outro-S.review); const pNow=Math.min(accum/S.total*100,100); $('#elapsed').style.width=pNow+'%'; $('#cursor').style.left=`calc(${pNow}% - 1px)`; $('#clockWT').textContent=fmt(accum); $('#clockWT').classList.toggle('over',accum>=S.total); $('#message').textContent=`Avsnitt ${i}${readSet.has(i)?' + Les-skriftsted':''}`; });
    t.insertBefore(slot,$('#elapsed'));
  }
  $('#elapsed').style.width='0%'; $('#cursor').style.left='0%';
}
// Klikk på introfeltet: hopp til 00:00 når ikke spiller (eller pauset)
(function(){
  const intro = document.getElementById('introSlot');
  if(intro){
    intro.style.cursor = 'pointer';
    intro.addEventListener('click', ()=>{
      if(!started || paused){
        accum = 0;
        document.getElementById('elapsed').style.width = '0%';
        document.getElementById('cursor').style.left = '0%';
        document.getElementById('clockWT').textContent = '00:00';
        document.getElementById('clockWT').classList.remove('over');
        document.getElementById('message').textContent = 'Tilbake til start (00:00)';
      }
    });
  }
})();

let _rAF=null; function relayout(){ drawTimeline(); drawTimelineSP(); }
['resize','orientationchange'].forEach(ev=>{ window.addEventListener(ev, ()=>{ if(_rAF) cancelAnimationFrame(_rAF); _rAF=requestAnimationFrame(relayout); }); });

/* ===== WT klokke og meldinger ===== */
function lockWTControls(){
  const card = document.getElementById('wtControlsCard');
  const sel = document.getElementById('weekSel');
  const m60 = document.getElementById('mode60');
  const m30 = document.getElementById('mode30');
  if(card) card.classList.add('locked');
  if(sel){ sel.setAttribute('disabled','disabled'); }
  if(m60){ m60.setAttribute('disabled','disabled'); }
  if(m30){ m30.setAttribute('disabled','disabled'); }
}
function unlockWTControls(){
  const card = document.getElementById('wtControlsCard');
  const sel = document.getElementById('weekSel');
  const m60 = document.getElementById('mode60');
  const m30 = document.getElementById('mode30');
  if(card) card.classList.remove('locked');
  if(sel){ sel.removeAttribute('disabled'); }
  if(m60){ m60.removeAttribute('disabled'); }
  if(m30){ m30.removeAttribute('disabled'); }
}

function resetWTUI(){
  if(tickHandle)clearInterval(tickHandle);
  $('#clockWT').textContent='00:00'; $('#clockWT').classList.remove('over');
  $('#message').textContent='Klar til start. Trykk ▶ når du er klar.';
  started=false; paused=false; startTs=null; accum=0; wtLastE=0; wtMsgHoldUntil=0; wtShownWarn=false;
  $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=true;
  unlockWTControls();
}
function startClock(){ if(tickHandle)clearInterval(tickHandle); tickHandle=setInterval(tickWT,250) }
function stopClock(){ if(tickHandle)clearInterval(tickHandle); tickHandle=null }
function nowElapsed(){ if(!started) return accum; if(paused) return accum; return accum+Math.floor((Date.now()-startTs)/1000)}
function setWTMessage(txt){ $('#message').textContent=txt }
function wtFlash(msg,ms=10000){ setWTMessage(msg); wtMsgHoldUntil=Date.now()+ms; if(wtMsgHoldTimer) clearTimeout(wtMsgHoldTimer); wtMsgHoldTimer=setTimeout(()=>{ wtMsgHoldTimer=null },ms) }
function tickWT(){
  const S=slots();
  const e=nowElapsed(), remaining=S.total-e;
  $('#clockWT').textContent=fmt(e); $('#clockWT').classList.toggle('over',e>=S.total);
  const p=Math.min(e/S.total*100,100); $('#elapsed').style.width=p+'%'; $('#cursor').style.left=`calc(${p}% - 1px)`;
  const warnAt = (getMode()==='30') ? 300 : 600;
  if(!wtShownWarn && remaining<=warnAt && remaining>0){ wtShownWarn=true; wtFlash((warnAt/60)+' min igjen – dette klarer du! 😎', 15000) }
  if(wtMsgHoldTimer && Date.now()<wtMsgHoldUntil){ return }
  if(e<S.intro) setWTMessage('Introduksjon');
  else if(e>=S.total) setWTMessage('Tiden er brukt – teller over');
  else if(e>=S.total-S.outro) setWTMessage('Avslutning');
  else if(e>=S.total-S.outro-S.review) setWTMessage('Repetisjonsspørsmål');
  else{
    let idx=0;
    for(let i=0;i<totalParagraphs;i++){
      const s=cumulative[i], end=(i===totalParagraphs-1)?(S.total-S.outro-S.review):cumulative[i+1];
      if(e>=s&&e<end){idx=i;break}
    }
    let msg=`Avsnitt ${idx+1}${readSet.has(idx+1)?' + Les-skriftsted':''}`;
    if(e>=Math.floor(S.total/2) && e<Math.floor(S.total/2)+60) msg+=' – du er halvveis';
    setWTMessage(msg);
  }
}
function setPressedWT(id){ ['playWT','pauseWT','stopWT'].forEach(x=>{ const el=document.getElementById(x); if(el) el.classList.toggle('pressed', x===id); }); }
$('#playWT').addEventListener('click',()=>{
  if(started && paused){ paused=false; startTs=Date.now(); startClock(); tickWT(); setWTMessage('Fortsetter'); $('#playWT').disabled=true; $('#pauseWT').disabled=false; $('#stopWT').disabled=false; setPressedWT('playWT'); lockWTControls(); return }
  if(!started){ started=true; paused=false; startTs=Date.now(); startClock(); tickWT(); setWTMessage('Introduksjon'); $('#playWT').disabled=true; $('#pauseWT').disabled=false; $('#stopWT').disabled=false; setPressedWT('playWT'); lockWTControls(); }
});
$('#pauseWT').addEventListener('click',()=>{
  if(!started||paused) return;
  accum+=Math.floor((Date.now()-startTs)/1000); paused=true; stopClock(); setWTMessage('Pause');
  $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=false; setPressedWT('pauseWT');
});
$('#stopWT').addEventListener('click',()=>{
  if(started&&!paused) accum+=Math.floor((Date.now()-startTs)/1000);
  started=false; paused=false; stopClock();
  const e=accum;
  setWTMessage(`Ferdig – totalt ${fmt(e)}`);
  $('#playWT').disabled=false; $('#pauseWT').disabled=true; $('#stopWT').disabled=true;
  accum=0; $('#elapsed').style.width='0%'; $('#cursor').style.left='0%'; setPressedWT('stopWT'); unlockWTControls();
});

/* ===== WT modus-bryter ===== */
(function(){
  const m60=$('#mode60'), m30=$('#mode30');
  // Tving standard til 60 min ved oppstart
  try{ localStorage.setItem('meetingTimer.wtMode','60'); }catch(e){}
  const cur=getMode(); // blir '60'
  // UI: sørg for at 60 er aktiv
  m60.classList.add('active'); m30.classList.remove('active');
  m60.addEventListener('click',()=>{ if(getMode()==='60') return; setMode('60'); m60.classList.add('active'); m30.classList.remove('active'); computeAllocation(); drawTimeline(); resetWTUI(); });
  m30.addEventListener('click',()=>{ if(getMode()==='30') return; setMode('30'); m30.classList.add('active'); m60.classList.remove('active'); computeAllocation(); drawTimeline(); resetWTUI(); setWTMessage('Klar for å starte et forkortet vakttårnstudium.'); });
})();

/* ===== TIMER (SP) ===== */
const PRESET_KEY='meetingTimer.annetSeconds';
const spPresets=[...document.querySelectorAll('#spInputs .preset')];
let spRunning=false, spPaused=false, spStart=null, spAccum=0, spTick=null;
let SP_TOTAL=parseInt(localStorage.getItem(PRESET_KEY),10); if(isNaN(SP_TOTAL)) SP_TOTAL=600; // default 10 min
function isCountUp(){ return SP_TOTAL===0 }
function spFmt(s){s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0')}
function spElapsed(){ if(!spRunning) return spAccum; if(spPaused) return spAccum; return spAccum+Math.floor((Date.now()-spStart)/1000) }
function markPreset(s){ spPresets.forEach(b=>b.classList.toggle('active',parseInt(b.dataset.sec,10)===s)) }
function updatePlayIcon(){ const iconEl=document.getElementById('playSPIcon'); if(iconEl) iconEl.textContent=isCountUp()?'⏱️':'▶' }
function applyIdleClock(){ const el=$('#clockSP'); if(!el) return; el.classList.remove('over'); el.textContent=isCountUp()?'00:00':spFmt(SP_TOTAL) }
function drawTimelineSP(){
  const totalScale=isCountUp()?Math.max(1800,spElapsed()+1):SP_TOTAL;
  const e=spElapsed();
  const progress=Math.min(1, totalScale ? (e/totalScale) : 0);
  $('#elapsedSP').style.width=(progress*100)+'%'; $('#cursorSP').style.left=`calc(${progress*100}% - 1px)`;
  // Minuttstreker (1 / 5 / 10)
  const ticksC = $('#ticksSP'); if(!ticksC) return;
  ticksC.innerHTML='';
  const minutes = Math.floor(totalScale/60);
  for(let m=0; m<=minutes; m++){
    const x = (m*60/totalScale)*100;
    const i = document.createElement('i');
    i.className = 'tick' + (m%10===0 ? ' xmajor' : (m%5===0 ? ' major' : ''));
    i.style.left = x+'%';
    ticksC.appendChild(i);
  }
}
function showMilestone(name){ const el=$('#msImg'); if(!el) return; if(!name){ el.style.display='none'; el.removeAttribute('src'); return } el.style.display='block'; el.src=name }
function updateSP(){
  const e=spElapsed();
  if(isCountUp()){ $('#clockSP').classList.remove('over'); $('#clockSP').textContent=spFmt(e) }
  else { const remain=SP_TOTAL-e; if(remain>=0){ $('#clockSP').classList.remove('over'); $('#clockSP').textContent=spFmt(remain) } else { $('#clockSP').classList.add('over'); $('#clockSP').textContent=spFmt(-remain) } }
  drawTimelineSP();
}
function setPressedSP(id){ ['playSP','pauseSP','stopSP'].forEach(x=>{ const el=document.getElementById(x); if(el) el.classList.toggle('pressed', x===id); }); }
function spStartFn(){
  if(spRunning && spPaused){
    spPaused=false; spStart=Date.now(); spTick&&clearInterval(spTick); spTick=setInterval(updateSP,250);
    $('#playSP').disabled=true; $('#pauseSP').disabled=false; $('#stopSP').disabled=false; setPressedSP('playSP'); return;
  }
  if(!spRunning){
    spRunning=true; spPaused=false; spStart=Date.now(); spAccum=0;
    spTick&&clearInterval(spTick); spTick=setInterval(updateSP,250);
    $('#playSP').disabled=true; $('#pauseSP').disabled=false; $('#stopSP').disabled=false; setPressedSP('playSP');
    // LÅS milestone ved start (bytter ikke underveis)
    if(!isCountUp()){
      if(SP_TOTAL===1800) showMilestone('./img/milestone-30.png');
      else if(SP_TOTAL===900) showMilestone('./img/milestone-15.png');
      else if(SP_TOTAL===600) showMilestone('./img/milestone-10.png');
      else if(SP_TOTAL===300) showMilestone('./img/milestone-5.png');
      else showMilestone('./img/milestone-other.png');
    }else{
      showMilestone('./img/start-stopwatch.png');
    }
    updateSP();
  }
}
function spPauseFn(){ if(!spRunning||spPaused) return; spAccum+=Math.floor((Date.now()-spStart)/1000); spPaused=true; spTick&&clearInterval(spTick); spTick=null; $('#playSP').disabled=false; $('#pauseSP').disabled=true; $('#stopSP').disabled=false; setPressedSP('pauseSP'); updateSP() }
function spStopFn(){ if(spRunning&&!spPaused) spAccum+=Math.floor((Date.now()-spStart)/1000); spRunning=false; spPaused=false; spStart=null; spAccum=0; spTick&&clearInterval(spTick); spTick=null; showMilestone('./img/milestone-stop.png'); $('#playSP').disabled=false; $('#pauseSP').disabled=true; $('#stopSP').disabled=true; $('#clockSP').classList.remove('over'); setPressedSP('stopSP'); drawTimelineSP(); applyIdleClock(); }
$('#playSP').addEventListener('click',spStartFn); $('#pauseSP').addEventListener('click',spPauseFn); $('#stopSP').addEventListener('click',spStopFn);

/* Preset clicks */
spPresets.forEach(btn=>btn.addEventListener('click',()=>{
  if(spRunning) return;
  const s=parseInt(btn.dataset.sec,10)||0;
  localStorage.setItem(PRESET_KEY,String(s));
  SP_TOTAL=s;
  markPreset([0,300,600,900,1800].includes(SP_TOTAL)?SP_TOTAL:-1);
  applyIdleClock(); updatePlayIcon(); showMilestone('./img/pick-milestone.png'); drawTimelineSP(); updateSP(); updateTargetBox();
}));

/* +/- justering av mål-tid */
function clampTarget(v){ return Math.max(0, Math.min(3600, v)); }
function setTargetSeconds(sec){
  if(spRunning) return;
  SP_TOTAL=clampTarget(sec);
  localStorage.setItem(PRESET_KEY,String(SP_TOTAL));
  markPreset([0,300,600,900,1800].includes(SP_TOTAL)?SP_TOTAL:-1);
  applyIdleClock(); updatePlayIcon(); drawTimelineSP(); updateSP(); updateTargetBox();
}
function updateTargetBox(){ const box=document.getElementById('spTargetDisplay'); if(box) box.textContent= isCountUp() ? '00:00' : fmt(SP_TOTAL); }
document.getElementById('decSP').addEventListener('click',()=> setTargetSeconds(SP_TOTAL - 60));
document.getElementById('incSP').addEventListener('click',()=> setTargetSeconds(SP_TOTAL + 60));

/* ===== Init ===== */
(async function init(){
  // Tving standard til 60 min ved oppstart
  try{ localStorage.setItem('meetingTimer.wtMode','60'); }catch(e){}
  // Marker UI for 60
  document.getElementById('mode60').classList.add('active');
  document.getElementById('mode30').classList.remove('active');

  // Presets/klokker
  markPreset([0,300,600,900,1800].includes(SP_TOTAL)?SP_TOTAL:-1);
  applyIdleClock(); updatePlayIcon(); drawTimelineSP(); updateTargetBox();

  // Hydrate article list
  try{ await hydrateOptions(); }catch(e){ console.warn('hydrate failed', e); const sel=document.getElementById('weekSel'); if(sel){ sel.innerHTML='<option>Ingen data</option>'; } }

  // Deaktiver høyreklikk på alle bilder
  document.addEventListener('contextmenu', (e)=>{ if(e.target && e.target.closest('img')) { e.preventDefault(); } }, {capture:true});
})();

}); // DOMContentLoaded
</script>

<script>
// === VT Enhancements: groups + frames/reads (a/b) + correct counters in pills ===
(function(){
  function parseGroupsString(str) {
    if (!str || typeof str !== 'string') return [];
    return str.split(',').map(s => s.trim()).flatMap(token => {
      const m = token.match(/^(\d+)(?:-(\d+))?$/);
      if (!m) return [];
      const a = Number(m[1]), b = m[2] ? Number(m[2]) : a;
      const group = []; for (let x=a; x<=b; x++) group.push(x);
      return [group];
    });
  }
  function parseAnnoFlexible(entry) {
    if (typeof entry === 'number') return { para: entry, order: null };
    const m = String(entry).toLowerCase().trim().match(/^(\d+)([a-z])?$/);
    if (!m) return null;
    return { para: Number(m[1]), order: m[2] ?? null };
  }
  function buildAnnotations(frames = [], reads = [], legacyReadParas = null) {
    const ordIdx = o => (o ? (o.charCodeAt(0) - 96) : null);
    const ann = new Map();
    const upsert = (p, key, o) => {
      if (!ann.has(p)) ann.set(p, { frame: null, read: null });
      ann.get(p)[key] = { present: true, ordIdx: ordIdx(o) };
    };
    (frames||[]).map(parseAnnoFlexible).filter(Boolean).forEach(x => upsert(x.para, 'frame', x.order));
    if ((reads||[]).length) (reads||[]).map(parseAnnoFlexible).filter(Boolean).forEach(x => upsert(x.para, 'read', x.order));
    else if (Array.isArray(legacyReadParas)) legacyReadParas.forEach(p => upsert(Number(p), 'read', null));
    return ann;
  }
  function rangeLabel(nums) {
    const sorted = [...new Set(nums)].sort((a,b)=>a-b);
    const contiguous = sorted.every((v,i)=> i===0 || v === sorted[i-1] + 1);
    if (sorted.length === 1) return `Avsnitt ${sorted[0]}`;
    return contiguous ? `Avsnittene ${sorted[0]}–${sorted[sorted.length-1]}` : `Avsnittene ${sorted.join('+')}`;
  }
  function orderExtrasForParas(paras, annotations) {
    let hasF=false, hasR=false, minF=null, minR=null;
    for (const p of paras) {
      const a = annotations.get(p); if (!a) continue;
      if (a.frame?.present){ hasF=true; if(a.frame.ordIdx!=null) minF = (minF==null? a.frame.ordIdx : Math.min(minF,a.frame.ordIdx)); }
      if (a.read?.present) { hasR=true; if(a.read.ordIdx!=null)  minR = (minR==null? a.read.ordIdx  : Math.min(minR, a.read.ordIdx)); }
    }
    if (!hasF && !hasR) return [];
    if (hasF && hasR) {
      if (minF!=null || minR!=null) return ((minF ?? 1e9) <= (minR ?? 1e9)) ? ['ramme','les-skriftsted'] : ['les-skriftsted','ramme'];
      return ['ramme','les-skriftsted'];
    }
    return hasF ? ['ramme'] : ['les-skriftsted'];
  }
  function groupColor(groupId){
    if (groupId === null) return null;
    const baseHue = 150; const l = 66 - (groupId % 3) * 8;
    return `hsl(${baseHue} 40% ${l}%)`;
  }
  function ensureFramesPill(){
    if (document.getElementById('pillFrames')) return;
    const pillReads = document.getElementById('pillReads');
    if (!pillReads) return;
    const el = document.createElement('div');
    el.className = 'pill';
    el.id = 'pillFrames';
    el.innerHTML = '<span style="display:inline-flex;gap:6px;align-items:center"><img src="./img/box-icon.png" alt="" style="height:14px;vertical-align:-2px">Rammer: <strong>0</strong></span>';
    // Insert right after pillReads
    const parent = pillReads.parentElement;
    if (parent) parent.insertBefore(el, pillReads.nextSibling);
  }
  function setPillCounts({parasCount, readsCount, framesCount}){
    const p = document.querySelector('#pillParas');
    const r = document.querySelector('#pillReads');
    const f = document.querySelector('#pillFrames strong');
    if (p) p.textContent = `Avsnitt: ${parasCount ?? 0}`;
    if (r) r.textContent = `📖 Les-skriftsteder: ${readsCount ?? 0}`;
    if (f) f.textContent = String(framesCount ?? 0);
  }
  function computeCounts(it){
    const parasCount = Array.isArray(it.words) ? it.words.length
      : (Array.isArray(it.para_lengths) ? it.para_lengths.length : 0);
    let readsCount = 0;
    if (Array.isArray(it.reads) && it.reads.length){
      const nums = it.reads.map(e=>{ const m=String(e).match(/^(\d+)/); return m? Number(m[1]) : null; }).filter(n=>Number.isFinite(n));
      readsCount = new Set(nums).size;
    } else if (Array.isArray(it.readParas)) {
      readsCount = it.readParas.length;
    } else if (Array.isArray(it.read_paras)) {
      readsCount = it.read_paras.length;
    }
    let framesCount = 0;
    if (Array.isArray(it.frames) && it.frames.length){
      const nums = it.frames.map(e=>{ const m=String(e).match(/^(\d+)/); return m? Number(m[1]) : null; }).filter(n=>Number.isFinite(n));
      framesCount = new Set(nums).size;
    }
    return { parasCount, readsCount, framesCount };
  }

  const _origUseItem = window.useItem;
  const _origDrawTimeline = window.drawTimeline;

  window.useItem = function(it){
    // Back-compat: populate words from para_lengths
    if (Array.isArray(it.para_lengths) && (!Array.isArray(it.words) || !it.words.length)) {
      it.words = it.para_lengths.slice();
    }
    // Save groups/annotations
    window.__VT_GROUPS = parseGroupsString(typeof it.groups === 'string' ? it.groups : "");
    const frames = Array.isArray(it.frames) ? it.frames : [];
    const reads  = Array.isArray(it.reads)  ? it.reads  : [];
    const legacyRP = Array.isArray(it.readParas) ? it.readParas : (Array.isArray(it.read_paras) ? it.read_paras : null);
    window.__VT_ANN = buildAnnotations(frames, reads, legacyRP);
    // Backfill readParas for legacy UI that depends on it
    if (!Array.isArray(it.readParas) && !Array.isArray(it.read_paras) && reads.length){
      const nums = reads.map(e=>{ const m=String(e).match(/^(\d+)/); return m? Number(m[1]) : null; }).filter(n=>Number.isFinite(n));
      if (nums.length) it.readParas = nums;
    }
    // Update pills
    try{
      ensureFramesPill();
      setPillCounts(computeCounts(it));
    }catch(e){}
    return _origUseItem.apply(this, arguments);
  };

  function enhanceTimeline(){
    try{
      const t = document.getElementById('timeline'); if(!t) return;
      const slots = Array.from(t.querySelectorAll('.para-slot'));
      const groups = window.__VT_GROUPS || [];
      const ann = window.__VT_ANN || new Map();
      const paraToGroupId = new Map();
      groups.forEach((g,i)=> g.forEach(p => paraToGroupId.set(p, i)));
      slots.forEach((slot, idx) => {
        const p = idx+1;
        const gid = paraToGroupId.has(p) ? paraToGroupId.get(p) : null;
        const col = groupColor(gid);
        if (col) slot.style.background = col;
        // Recreate pins sorted by a/b
        slot.querySelectorAll('.read-pin,.frame-pin').forEach(n => n.remove());
        const a = ann.get(p);
        if (a){
          const items = [];
          if (a.frame?.present) items.push({type:'frame', order: a.frame.ordIdx ?? 1});
          if (a.read?.present)  items.push({type:'read',  order: a.read.ordIdx  ?? 2});
          items.sort((x,y)=>x.order-y.order);
          const gap = 12, base = -((items.length-1)/2)*gap;
          items.forEach((it, i) => {
            const pin = document.createElement('i');
            pin.className = it.type === 'frame' ? 'frame-pin' : 'read-pin';
            pin.style.left = `calc(50% + ${base + i*gap}px)`;
            slot.appendChild(pin);
          });
        }
        slot.addEventListener('click', ()=>{
          setTimeout(()=>{
            const group = groups.find(g => g.includes(p)) || [p];
            const extras = orderExtrasForParas(group, ann);
            const msg = document.getElementById('message');
            if (msg) msg.textContent = extras.length ? `${rangeLabel(group)} + ${extras.join(' og ')}` : rangeLabel(group);
          }, 0);
        }, { once: false });
      });
    }catch(e){}
  }

  window.drawTimeline = function(){
    const r = _origDrawTimeline.apply(this, arguments);
    setTimeout(enhanceTimeline, 0);
    return r;
  };
})();
</script>

</body>
</html>
